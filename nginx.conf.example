events {
    worker_connections 1024;
}

http {
    upstream gemsec {
        server gemsec:3030;
        # For multiple replicas, add more servers:
        # server gemsec-2:3030;
        # server gemsec-3:3030;
    }

    # HTTP server (redirect to HTTPS in production)
    server {
        listen 80;
        server_name mcp.gempurbayu.com;

        # Redirect HTTP to HTTPS
        return 301 https://$server_name$request_uri;
    }

    # HTTPS server for mcp.gempurbayu.com/gemsec-sse
    server {
        listen 443 ssl http2;
        server_name mcp.gempurbayu.com;

        # SSL certificates (update paths to your actual certificate files)
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Main MCP endpoint: /gemsec-sse -> backend root
        # This strips /gemsec-sse prefix and proxies to backend
        location /gemsec-sse {
            # Remove /gemsec-sse prefix and proxy to backend root
            rewrite ^/gemsec-sse(.*)$ $1 break;
            proxy_pass http://gemsec;
            proxy_http_version 1.1;
            
            # SSE/Streamable HTTP headers
            proxy_set_header Connection '';
            proxy_set_header Cache-Control no-cache;
            proxy_buffering off;
            proxy_set_header X-Accel-Buffering no;
            
            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Increase timeouts for SSE connections
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # Health check endpoint (optional, for monitoring)
        location /gemsec-sse/healthz {
            rewrite ^/gemsec-sse(.*)$ $1 break;
            proxy_pass http://gemsec/healthz;
            access_log off;
        }

        # Alternative: If you want to keep /gemsec-sse in backend path
        # Uncomment this and comment the above location blocks:
        # location /gemsec-sse {
        #     proxy_pass http://gemsec/gemsec-sse;
        #     proxy_http_version 1.1;
        #     proxy_set_header Connection '';
        #     proxy_set_header Cache-Control no-cache;
        #     proxy_buffering off;
        #     proxy_set_header X-Accel-Buffering no;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        #     proxy_read_timeout 300s;
        #     proxy_connect_timeout 75s;
        # }
    }

    # Example: Alternative configuration for root path (if needed)
    # Uncomment if you want to serve MCP at root path instead of /gemsec-sse
    # server {
    #     listen 443 ssl http2;
    #     server_name mcp.gempurbayu.com;
    #
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers HIGH:!aNULL:!MD5;
    #
    #     location / {
    #         proxy_pass http://gemsec;
    #         proxy_http_version 1.1;
    #         
    #         # SSE/Streamable HTTP headers
    #         proxy_set_header Connection '';
    #         proxy_set_header Cache-Control no-cache;
    #         proxy_buffering off;
    #         proxy_set_header X-Accel-Buffering no;
    #         
    #         # Standard proxy headers
    #         proxy_set_header Host $host;
    #         proxy_set_header X-Real-IP $remote_addr;
    #         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #         proxy_set_header X-Forwarded-Proto $scheme;
    #         
    #         # Increase timeouts for SSE connections
    #         proxy_read_timeout 300s;
    #         proxy_connect_timeout 75s;
    #     }
    #
    #     location /healthz {
    #         proxy_pass http://gemsec/healthz;
    #         access_log off;
    #     }
    # }
}

